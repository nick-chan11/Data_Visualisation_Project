{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "config": {
    "text": {"font": "Segoe UI, Arial, sans-serif"},
    "axis": {"labelFont": "Segoe UI, Arial, sans-serif", "titleFont": "Segoe UI, Arial, sans-serif"},
    "legend": {"labelFont": "Segoe UI, Arial, sans-serif", "titleFont": "Segoe UI, Arial, sans-serif"},
    "title": {"font": "Segoe UI, Arial, sans-serif"}
  },
  "width": 450,
  "height": 450,
  "padding": {"left": 20, "right": 20, "top": 20, "bottom": 20},
  "title": "Australian Domestic Flight On-Time Performance vs Route Distance",
  "data": {
    "url": "https://raw.githubusercontent.com/ncha0085/FIT3179/refs/heads/main/data/otp_time_series_web.csv"
  },
  "params": [
    {
      "name": "PerfType",
      "value": "Arrivals",
      "bind": {
        "input": "select",
        "options": ["Arrivals", "Departures"],
        "labels": ["Arrivals", "Departures"],
        "name": "Performance Type: "
      }
    },
    {
      "name": "YearFilter",
      "value": 2023,
      "bind": {
        "input": "range",
        "min": 2004,
        "max": 2024,
        "step": 1,
        "name": "Year: "
      }
    },
    {
      "name": "highlight",
      "select": {"type": "point", "on": "mouseover"}
    }
  ],
  "transform": [
    {
      "filter": "datum.Year == YearFilter"
    },
    {
      "calculate": "PerfType == 'Arrivals' ? datum.Arrivals_On_Time / datum.Sectors_Flown : datum.Departures_On_Time / datum.Sectors_Flown",
      "as": "OnTimePerformance"
    },
    {
      "calculate": "sqrt(pow(datum.Longitude_City2 - datum.Longitude_City1, 2) + pow(datum.Latitude_City2 - datum.Latitude_City1, 2)) * 111",
      "as": "RouteDistance"
    },
    {
      "filter": "datum.OnTimePerformance > 0 && datum.RouteDistance > 0"
    },
    {
      "aggregate": [
        {"op": "mean", "field": "OnTimePerformance", "as": "AvgOnTimePerformance"},
        {"op": "mean", "field": "RouteDistance", "as": "AvgDistance"},
        {"op": "sum", "field": "Sectors_Flown", "as": "TotalFlights"}
      ],
      "groupby": ["Route", "Departing_Port", "Arriving_Port"]
    }
  ],
  "mark": {
    "type": "circle",
    "stroke": "black",
    "strokeWidth": 0.1
  },
  "encoding": {
    "x": {
      "field": "AvgDistance",
      "type": "quantitative",
      "title": "Route Distance (km)",
      "scale": {"domain": [0, 4500]}
    },
    "y": {
      "field": "AvgOnTimePerformance",
      "type": "quantitative",
      "title": "On-Time Performance (%)",
      "axis": {"format": "%"},
      "scale": {"domain": [0, 1]}
    },
    "size": {
      "field": "TotalFlights",
      "type": "quantitative",
      "title": "Total Flights",
      "scale": {"range": [50, 400]}
    },
    "color": {
      "field": "AvgOnTimePerformance",
      "type": "quantitative",
      "title": "On-Time %",
      "scale": {
        "scheme": "viridis",
        "reverse": false
      }
    },
    "opacity": {
      "condition": {
        "param": "highlight",
        "value": 1.0
      },
      "value": 0.3
    },
    "strokeWidth": {
      "condition": {
        "param": "highlight",
        "value": 1.5
      },
      "value": 0.2
    },
    "tooltip": [
      {"field": "Route", "type": "nominal", "title": "Route"},
      {"field": "Departing_Port", "type": "nominal", "title": "From"},
      {"field": "Arriving_Port", "type": "nominal", "title": "To"},
      {"field": "AvgDistance", "type": "quantitative", "title": "Distance (km)", "format": ".0f"},
      {"field": "AvgOnTimePerformance", "type": "quantitative", "title": "On-Time Performance", "format": ".1%"},
      {"field": "TotalFlights", "type": "quantitative", "title": "Total Flights", "format": ","}
    ]
  }
}